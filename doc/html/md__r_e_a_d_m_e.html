<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Research Track 1 Assignment 2: Assignment 2</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Research Track 1 Assignment 2
   </div>
   <div id="projectbrief">R</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Assignment 2 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Mia La Rocca\ S6344889</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Components</h1>
<div class="fragment"><div class="line">├── action</div>
<div class="line">│   └── Planning.action</div>
<div class="line">├── CMakeLists.txt</div>
<div class="line">├── launch</div>
<div class="line">│   └── assignment2.launch</div>
<div class="line">├── msg</div>
<div class="line">│   └── PosVel.msg</div>
<div class="line">├── package.xml</div>
<div class="line">├── README.md</div>
<div class="line">├── src</div>
<div class="line">│   ├── distance_speed_server.cpp</div>
<div class="line">│   ├── keyboard_parser.cpp</div>
<div class="line">│   ├── target_server.cpp</div>
<div class="line">│   └── target_setter.cpp</div>
<div class="line">└── srv</div>
<div class="line">    ├── DistanceSpeed.srv</div>
<div class="line">    └── Target.srv</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md2"></a>
Source Code</h2>
<p>Four separate nodes were created for this assignment: the target setter, target server, distance speed server, and the keyboard parser.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
Target Setter</h3>
<p>The target setter is an action client to the bug action implemented in assignment_2_2023. The target setter reads in clicked points (<code>/clicked_point</code>) from rviz and then sends them to the action server as the goal point. The target setter also listens to the <code>/key_in</code> topic to get the input from stdin to either set or cancel a target. The target setter listens to the feedback from the server and prints to the console if the state has changed. The target server also subscribes to the <code>/odom</code> and converts those messages to the custom PosVel messages and publishes them on the <code>/posvel</code> topic.</p>
<h3><a class="anchor" id="autotoc_md4"></a>
Target Server</h3>
<p>When called the target server looks up the target position from the ros parameters "des_pos_x" and "des_pos_y" and then publishes them.</p>
<h3><a class="anchor" id="autotoc_md5"></a>
Distance Speed Server</h3>
<p>The distance speed server subscribes to the /posvel topic. Every time it receives a posvel message, calls the target server to get the target position. Then it updates its internal storage with the distance of the robot from the target and the average speed. The window used to calculate the average speed is set by the parameter <code>avg_window_size</code>. When the service is called, it returns the distance and average speed.</p>
<h3><a class="anchor" id="autotoc_md6"></a>
Keyboard Parser</h3>
<p>The keyboard parser reads in the std input and publishes it to the <code>/key_in</code> topic. This is a separate module from the target setter so it can use blocking functions to read the input and not disturb anything else.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Action</h2>
<p>The action folder includes the file that describes the communication between the action client and the action server. This was copied over from the assignment_2_2023 repo. </p>
<h2><a class="anchor" id="autotoc_md8"></a>
Launch</h2>
<p>The launch folder includes a launch file that launches the simulation environment, provided action server, and the four nodes created for this assignment. </p>
<h2><a class="anchor" id="autotoc_md9"></a>
Messages</h2>
<p>A new custom message was created to describe the robots motion.\ PosVel.msg:\ &ensp;&ensp;x (float64): x position of the robot\ &ensp;&ensp;y (float64): y position of the robot\ &ensp;&ensp;vel_x (float64): linear speed of the robot in the x direction\ &ensp;&ensp;vel_z (float 64): angular speed of the robot in the z direction </p>
<h2><a class="anchor" id="autotoc_md10"></a>
Services</h2>
<p>Two service messages were created. One takes no arguments as a request and returns the target's x and y position. The second takes no arguments as a request and returns the robot's distance from the target and its average linear speed.</p>
<p>Target.srv:\ Request:\ &ensp;&ensp;[None]\ Response:\ &ensp;&ensp;target_x (float64): x position of the target\ &ensp;&ensp;target_y (float64): y position of the target</p>
<p>DistanceSpeed.srv:\ Request:\ &ensp;&ensp;[None]\ Response:\ &ensp;&ensp;distance (float64): distance between robot and target\ &ensp;&ensp;average_speed (float64): average speed of the robot (taken with a parameter defined window size)</p>
<h1><a class="anchor" id="autotoc_md11"></a>
RQT Graph</h1>
<p><img src="./doc/rosgraph.png" alt="rqt_graph" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md12"></a>
Target Setter Pseudocode</h1>
<p>Because the target setter uses many callbacks, it is difficult to create a directional flow. Instead I will write pseudocode for the main function and each of the callback functions.</p>
<h2><a class="anchor" id="autotoc_md13"></a>
Main</h2>
<div class="fragment"><div class="line">Initialize ros node</div>
<div class="line">Create Action client</div>
<div class="line"> </div>
<div class="line">Create subscriber to /clicked_point with callback clicked_point_callback</div>
<div class="line">Create subscriber to /odom with callback odom_callback</div>
<div class="line">Create subscriber to /key_in with callback key_callback</div>
<div class="line">Create publisher to /posvel</div>
<div class="line"> </div>
<div class="line">Wait for action server</div>
<div class="line">Display instructions for setting target</div>
<div class="line"> </div>
<div class="line">spin</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md14"></a>
doneCb (Action Client)</h2>
<div class="fragment"><div class="line">Print finish state</div>
<div class="line">Display instructions for setting target</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
activeCb (Action Client)</h2>
<div class="fragment"><div class="line">Print that goal went active</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md16"></a>
feedbackCb (Action Client)</h2>
<div class="fragment"><div class="line">if (current action state is not previous action state)</div>
<div class="line">    print state and position</div>
<div class="line">    previous action state = current action state</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md17"></a>
clicked_point_callback</h2>
<div class="fragment"><div class="line">cancel all action server goals</div>
<div class="line">set goal x, y to equal clicked point x, y</div>
<div class="line">publish new goal to action server</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md18"></a>
odom_callback</h2>
<div class="fragment"><div class="line">create posvel message object</div>
<div class="line">assign posvel.x to equal odom x</div>
<div class="line">assign posvel.y to equal odom y</div>
<div class="line">assign posvel.vel_x to equal odom linear x velocity</div>
<div class="line">assign posvel.vel_z to equal odom angular z velocity</div>
<div class="line">publish posvel to the /posvel topic</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md19"></a>
key_callback</h2>
<div class="fragment"><div class="line">if the first character of the message is &#39;x&#39; or &#39;X&#39;</div>
<div class="line">  cancel all action server goals</div>
<div class="line">else if the first character of the message is &#39;T&#39;</div>
<div class="line">  parse the message to get the x, y</div>
<div class="line">  cancel all action server goals</div>
<div class="line">  publish new goal position</div>
<div class="line">else </div>
<div class="line">  print bad input</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md20"></a>
Operating Instructions</h1>
<h2><a class="anchor" id="autotoc_md21"></a>
Launching</h2>
<p>In your catkin workspace, run catkin_make. Then launch the following </p><div class="fragment"><div class="line">roslaunch r1_assignment_2 assignment2.launch</div>
</div><!-- fragment --><p> Check that you can see the laser scan in rviz. If not, replace the robot2_laser.gazebo file with the one in the melodic_laser branch of the robot_description repo.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Setting Targets</h2>
<p>To indicate a target for the robot, click the publish point in rviz and then click on the grid. Currently rviz only allows the user to click on the grid. A point will only be published if there is a small orange symbol next to the cursor when clicking on the grid. To expand the grid in rviz to the full size of the environment, set the grid plane cell count parameter to 18.</p>
<p>A target can also be indicated by typing its coordinates as 'T:[x],[y]' + Enter (e.g. T:4.5,6.3) in the console window that you launched from.</p>
<p>To cancel a target type an 'x' or 'X' into the console window that you launched from.</p>
<h2><a class="anchor" id="autotoc_md23"></a>
Using the Target Server</h2>
<div class="fragment"><div class="line">rosservice call /get_target</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md24"></a>
Using the Distance Speed Server</h2>
<div class="fragment"><div class="line">rosservice call /get_distance_speed</div>
</div><!-- fragment --> <h1><a class="anchor" id="autotoc_md25"></a>
Possible Improvements</h1>
<p>This first possible improvement woud be adding a map to the rviz window so the user can see the map of the environment when picking their desired target point. The distance server also currently needs to store the whole window size worth of speeds. If the way the average was calculated was changed to <code>avg(t) = (1-alpha)avg(t-1) + alpha * speed(t)</code>, then only the aveage would need to be stored and the alpha parameter can be used similar to the window size.</p>
<p>Right now the for the keyboard input is rather rudimentary. If the user inputs a capital T and then doesn't put the position in, it does not raise a bad input error. The goal position is kept the same but sent again as a new goal.</p>
<p>Also someitmes the robot accelerates so fast that it does a wheelie. This should be avoided as once it got stuck in a wheelie on the wall and could not move out of that position. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
